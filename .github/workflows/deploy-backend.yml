# Acción para desplegar el código del backend a Heroku
# TUTORIAL: https://medium.com/swlh/auto-deploying-a-monorepo-to-heroku-with-github-actions-da62e8ae172c

name: Desplegar backend a Heroku
on:
  # Ejecutar cuando se haga push a _main_ y hayan sido modificados ficheros del backend
  push:
    branches:
      - main
    paths:
      - "backend-TFG/**"
      - ".github/workflows/deploy-backend.yml"
jobs:
  # Desplegar código
  deploy:
    name: Containerize and deploy backend
    runs-on: ubuntu-20.04
    steps:
      # Clonar repositorio en máquina remota
      - name: Checkout code.
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Configurar JAVA 11 en la máquina de referencia
      - name: Set up JDK 11.
        uses: actions/setup-java@v1
        with:
          java-version: 11

      # Añadir remoto de heroku al repositorio
      - name: Add Heroku remote repository for backend
        run: git remote add heroku-backend https://heroku:${{ secrets.HEROKU_API_TOKEN }}@git.heroku.com/${{ secrets.HEROKU_BACKEND_APP_NAME }}.git

      # Pushear código al remoto de heroku para despliegue automático
      - name: Deploy backend to Heroku
        run: git push heroku-backend `git subtree split --prefix backend main`:refs/heads/master --force
